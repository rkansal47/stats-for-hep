

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3. Confidence Intervals and Limits &#8212; Stats for HEP</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03-intervals-and-limits';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Expected Significances and Limits" href="04-expected-significance-and-limits.html" />
    <link rel="prev" title="2. Hypothesis Testing and Upper Limits" href="02-hypothesis-testing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="main.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="main.html">
                    Stats for HEP
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01-intro.html">1. Introduction to Likelihoods and Test Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-hypothesis-testing.html">2. Hypothesis Testing and Upper Limits</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">3. Confidence Intervals and Limits</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-expected-significance-and-limits.html">4. Expected Significances and Limits</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-asymptotic-forms.html">5. Asymptotic Formulae</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/rkansal47/stats-for-HEP" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/rkansal47/stats-for-HEP/issues/new?title=Issue%20on%20page%20%2F03-intervals-and-limits.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/03-intervals-and-limits.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Confidence Intervals and Limits</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">3.1. Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intervals-and-limits">3.2. Intervals and limits</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">3.2.1. Confidence intervals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upper-limits">3.2.2. Upper Limits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cl-s-method">3.2.3. CL<span class="math notranslate nohighlight">\(_s\)</span> method</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">3.3. Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="confidence-intervals-and-limits">
<h1><span class="section-number">3. </span>Confidence Intervals and Limits<a class="headerlink" href="#confidence-intervals-and-limits" title="Permalink to this heading">#</a></h1>
<section id="recap">
<h2><span class="section-number">3.1. </span>Recap<a class="headerlink" href="#recap" title="Permalink to this heading">#</a></h2>
<p>We defined in Part 1 our probability model and likelihood function for a simple one bin counting experiment with <span class="math notranslate nohighlight">\(n\)</span> events, <span class="math notranslate nohighlight">\(s\)</span> signal and <span class="math notranslate nohighlight">\(b\)</span> background, in our signal region and <span class="math notranslate nohighlight">\(m\)</span> events, <span class="math notranslate nohighlight">\(b\)</span> background, in our control region:</p>
<div class="math notranslate nohighlight" id="equation-3model">
<span class="eqno">(3.1)<a class="headerlink" href="#equation-3model" title="Permalink to this equation">#</a></span>\[
P(n, m; s, b) = \frac{(s+b)^n e^{-(s+b)}}{n!} \cdot \frac{b^m e^{-b}}{m!} = L(s, b),
\]</div>
<p>and our test statistic <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-3ts-tilde">
<span class="eqno">(3.2)<a class="headerlink" href="#equation-3ts-tilde" title="Permalink to this equation">#</a></span>\[\begin{split}
\tilde{\lambda}(s) = \left\{
    \begin{array}{ll}
      \frac{L(s, \hat{\hat{b}}(s))}{L(\hat{s}, \hat{b})}, &amp; \mbox{$\hat{s}\geq0$}.\\
      \frac{L(s, \hat{\hat{b}}(s))}{L(0, \hat{\hat{b}}(0))}, &amp; \mbox{$\hat{s}&lt;0$}.
    \end{array}
  \right., \quad \tilde{t}_s=-2\ln \tilde{\lambda}(s),
\end{split}\]</div>
<p>and solved for <span class="math notranslate nohighlight">\(\hat{s}, \hat{b}, \hat{\hat{b}}(s)\)</span> for given <span class="math notranslate nohighlight">\(n, m\)</span> to find an analytic form for <span class="math notranslate nohighlight">\(t_s\)</span>.</p>
<p>In part 2, we translated this to a probability distribution of <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span> under a particular signal hypothesis <span class="math notranslate nohighlight">\(H_s\)</span>, and quantified the compatibility of our observation based on the <span class="math notranslate nohighlight">\(p\)</span>-value <span class="math notranslate nohighlight">\(p_s\)</span> of the observed test statistic <span class="math notranslate nohighlight">\(\tilde{t}_s^\mathrm{obs}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-3pvalue">
<span class="eqno">(3.3)<a class="headerlink" href="#equation-3pvalue" title="Permalink to this equation">#</a></span>\[
p_s = \int_{\tilde{t}_\mathrm{obs}}^{\infty}p(\tilde{t}_s|s)\mathrm d \tilde{t}_s,
\]</div>
<p>and it’s associated significance.</p>
<p>Code from previous parts:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">poisson</span><span class="p">,</span> <span class="n">chi2</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Latex</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_poisson_nofactorial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">mu</span> <span class="o">+</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">log_likelihood_nofactorial</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">log_poisson_nofactorial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_poisson_nofactorial</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">shat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">bhat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">bhathat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Using the quadratic formula and only the positive solution&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">m</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span>


<span class="k">def</span> <span class="nf">t_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;-2ln(lambda), b can optionally be fixed (for demo below)&quot;&quot;&quot;</span>
    <span class="n">bhh</span><span class="p">,</span> <span class="n">bh</span> <span class="o">=</span> <span class="p">(</span><span class="n">bhathat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">bhat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">log_likelihood_nofactorial</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bhh</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_likelihood_nofactorial</span><span class="p">(</span><span class="n">shat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">bh</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">t_zero_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Alternative test statistic when shat &lt; 0&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">log_likelihood_nofactorial</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bhathat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">log_likelihood_nofactorial</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bhathat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">t_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="c1">#     s, n, m = [np.array(x) for x in (s, n, m)]  # convert to numpy arrays</span>
    <span class="n">neg_shat_mask</span> <span class="o">=</span> <span class="n">shat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># find when s^ is &lt; 0</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">t_zero</span> <span class="o">=</span> <span class="n">t_zero_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="c1"># replace values where s^ &lt; 0 with lam_zero</span>
    <span class="n">ts</span><span class="p">[</span><span class="n">neg_shat_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_zero</span><span class="p">[</span><span class="n">neg_shat_mask</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_toys</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate toy data for a given s and observed n and m&quot;&quot;&quot;</span>
    <span class="c1">#  use b^^ for p(t_s|s) as recommended by Ref. 2</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">bhathat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">)</span>
    <span class="c1"># sample n, m according to our data model (Eq. 1)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_toys</span><span class="p">),</span> <span class="n">poisson</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_toys</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">get_p_ts</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the t_tilde_s test statistic distribution via toys.</span>
<span class="sd">    By default, the s we&#39;re testing is the same as the s we&#39;re using for toys,</span>
<span class="sd">    but this can be changed if necessary (as you will see later).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">toy_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toy_s</span> <span class="o">=</span> <span class="n">test_s</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">get_toys</span><span class="p">(</span><span class="n">toy_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t_tilde_s</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_ps_val</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;p value&quot;&quot;&quot;</span>
    <span class="n">t_tilde_ss</span> <span class="o">=</span> <span class="n">get_p_ts</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="p">)</span>
    <span class="n">t_obs</span> <span class="o">=</span> <span class="n">t_tilde_s</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">)</span>
    <span class="n">p_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_tilde_ss</span> <span class="o">&gt;</span> <span class="n">t_obs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_val</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_obs</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="intervals-and-limits">
<h2><span class="section-number">3.2. </span>Intervals and limits<a class="headerlink" href="#intervals-and-limits" title="Permalink to this heading">#</a></h2>
<section id="confidence-intervals">
<h3><span class="section-number">3.2.1. </span>Confidence intervals<a class="headerlink" href="#confidence-intervals" title="Permalink to this heading">#</a></h3>
<p>The machinery from Part 2 can be extended straightforwardly to extracting “confidence intervals” for our parameters of interest (POIs): a range of values of the POIs that are allowed based on the experiment, for a certain “confidence level”, e.g. 68% or 95%. Very similar to the idea of the significance level, the confidence level is defined such that if we were to repeat the experiment many times, a 95%-confidence-interval must contain, or <em>cover</em>, the true value of the parameter 95% of the time.</p>
<p>We can ensure this for any given confidence level (CL) by solving Eq. <a class="reference internal" href="#equation-3pvalue">(3.3)</a> for a <span class="math notranslate nohighlight">\(p\)</span>-value of <span class="math notranslate nohighlight">\(1 - \mathrm{CL}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-cl">
<span class="eqno">(3.4)<a class="headerlink" href="#equation-cl" title="Permalink to this equation">#</a></span>\[
p = 1 - \mathrm{CL} = \int_{\tilde{t}^\mathrm{obs}_s}^{\infty}p(\tilde{t}_s|s_\pm)\mathrm d \tilde{t}_s,
\]</div>
<p>where <span class="math notranslate nohighlight">\(s_-\)</span> and <span class="math notranslate nohighlight">\(s_+\)</span> are the lower and upper limits on <span class="math notranslate nohighlight">\(s\)</span>, respectively.</p>
<p>We solve this by scanning <span class="math notranslate nohighlight">\(s\)</span> and finding the values of <span class="math notranslate nohighlight">\(s\)</span> for which the RHS <span class="math notranslate nohighlight">\(= 1 - \mathrm{CL}\)</span>. Continuing with our above example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_limits</span><span class="p">(</span><span class="n">s_scan</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span>
    <span class="n">t_tilde_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving sampled test statistics for each s</span>
    <span class="n">t_obs_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving t_obs for each s</span>
    <span class="n">p_val_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving p-value for each s</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_scan</span><span class="p">:</span>
        <span class="n">p_val</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_obs</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
        <span class="n">t_obs_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_obs</span><span class="p">)</span>
        <span class="n">t_tilde_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_tilde_ss</span><span class="p">)</span>
        <span class="n">p_val_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_val</span><span class="p">)</span>

    <span class="c1"># find the values of s that give p_value ~= 1 - CL</span>
    <span class="n">pv_cl_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_val_scan</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CL</span><span class="p">))</span>
    <span class="c1"># split into lower and upper half to get lower and upper limits</span>
    <span class="c1"># (not the best way to do this, but works for now...)</span>
    <span class="n">half_num_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_scan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">s_low</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">[:</span><span class="n">half_num_s</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">s_high</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">half_num_s</span><span class="p">:][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">[</span><span class="n">half_num_s</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span><span class="p">,</span> <span class="n">t_tilde_scan</span><span class="p">,</span> <span class="n">t_obs_scan</span><span class="p">,</span> <span class="n">p_val_scan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_toys</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span>
<span class="n">s_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">30.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># scanning s over these values</span>
<span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span><span class="p">,</span> <span class="n">t_tilde_scan</span><span class="p">,</span> <span class="n">t_obs_scan</span><span class="p">,</span> <span class="n">p_val_scan</span> <span class="o">=</span> <span class="n">get_limits</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_low</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_high</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$s \in [</span><span class="si">{</span><span class="n">s_low</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">s_high</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">]$&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[s \in [5.8, 25.8]\]</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_2d_p_ts_s</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">t_tilde_s</span><span class="p">,</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">):</span>
    <span class="n">t_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
    <span class="n">t_tilde_hists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">t_tilde_s</span><span class="p">,</span> <span class="n">t_bins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_toys</span> <span class="k">for</span> <span class="n">t_tilde_s</span> <span class="ow">in</span> <span class="n">t_tilde_scan</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
        <span class="n">t_bins</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="mf">30.2</span><span class="p">),</span>
        <span class="n">t_tilde_hists</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;turbo&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="se">}}</span><span class="s2">_s$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$s$&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$p(\tilde</span><span class="se">{{</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="se">}}</span><span class="s2">_s|s)$&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_pval_levels</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">t_tilde_scan</span><span class="p">,</span> <span class="n">t_obs_scan</span><span class="p">,</span> <span class="n">s_high</span><span class="p">,</span> <span class="n">s_low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_lim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.0</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;t&quot;</span>
<span class="p">):</span>
    <span class="n">t_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_lim</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_s</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_vals</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t_s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">t_tilde_scan</span><span class="p">)])</span>
    <span class="n">clb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
        <span class="n">t_vals</span><span class="p">,</span>
        <span class="n">s_scan</span><span class="p">,</span>
        <span class="n">p_vals</span><span class="p">,</span>
        <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;turbo&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">clb</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$p$-value&quot;</span><span class="p">)</span>
    <span class="c1"># plot t_obs</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_obs_scan</span><span class="p">,</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">^\mathrm</span><span class="se">{{</span><span class="s2">obs</span><span class="se">}}</span><span class="s2">_s$&quot;</span><span class="p">)</span>
    <span class="c1"># plot s±</span>
    <span class="k">if</span> <span class="n">s_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
            <span class="p">[</span><span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span><span class="p">],</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">t_lim</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$s_\pm$&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
            <span class="n">s_high</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">t_lim</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$s_+$&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="se">}}</span><span class="s2">_s$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$s$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_lim</span><span class="p">])</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="c1"># plot p(t_s|s) for all values of s</span>
<span class="n">plot_2d_p_ts_s</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_tilde_s</span><span class="p">,</span> <span class="n">s_scan</span><span class="p">)</span>
<span class="c1"># plot the p-values as a function of t_s and s</span>
<span class="n">plot_pval_levels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">t_tilde_scan</span><span class="p">,</span> <span class="n">t_obs_scan</span><span class="p">,</span> <span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<figure class="align-default" id="neymanconstruction">
<img alt="_images/df99f734d43bce65718e12e3192d93a7e91d8333151a969220ae416801d809ce.png" src="_images/df99f734d43bce65718e12e3192d93a7e91d8333151a969220ae416801d809ce.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.1 </span><span class="caption-text">Demonstration of the Neyman construction for a 95% confidence interval. Left: <span class="math notranslate nohighlight">\(p(\tilde{t}_s|s)\)</span> for different values of <span class="math notranslate nohighlight">\(s\)</span>. Right: The <span class="math notranslate nohighlight">\(p\)</span>-values for different <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span>’s plus <span class="math notranslate nohighlight">\(t^\mathrm{obs}_s\)</span> in red. The points at which <span class="math notranslate nohighlight">\(t^\mathrm{obs}_s\)</span> intersects with the <span class="math notranslate nohighlight">\(p\)</span>-value = 0.05 contour signify the limits of the 95% confidence interval for <span class="math notranslate nohighlight">\(s\)</span>: <span class="math notranslate nohighlight">\([\)</span><span class="output text_plain">5.8</span>, <span class="output text_plain">25.8</span><span class="math notranslate nohighlight">\(]\)</span>.</span><a class="headerlink" href="#neymanconstruction" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p>This procedure of inverting the hypothesis test by scanning along the values of the POIs is called the “Neyman construction”.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>One subtlety to remember is that, in principle, we should also be scanning over the nuisance parameters (<span class="math notranslate nohighlight">\(b\)</span>) when estimating the <span class="math notranslate nohighlight">\(p\)</span>-values. However, this would be very computationally expensive so in practice we continue to use <span class="math notranslate nohighlight">\(b = \hat{\hat{b}}(s)\)</span>, to always (approximately) maximise the agreement with the hypothesis. Ref. <span id="id1">[<a class="reference internal" href="main.html#id5" title="Kyle Cranmer. Practical Statistics for the LHC. In 2011 European School of High-Energy Physics, 267–308. 2014. arXiv:1503.07622, doi:10.5170/CERN-2014-003.267.">2</a>]</span> calls this trick “profile construction”.</p>
</div>
</section>
<section id="upper-limits">
<h3><span class="section-number">3.2.2. </span>Upper Limits<a class="headerlink" href="#upper-limits" title="Permalink to this heading">#</a></h3>
<p>Typically if a search does not have enough sensitivity to directly observe a new signal, we instead quote an upper limit on the signal strength. This is similar in practice to the Neyman construction for confidence intervals, solving Eq. <a class="reference internal" href="#equation-cl">(3.4)</a> only for the upper boundary. However, when we’re setting upper limits, we need to modify our test statistic, as so:</p>
<div class="math notranslate nohighlight" id="equation-qs-tilde">
<span class="eqno">(3.5)<a class="headerlink" href="#equation-qs-tilde" title="Permalink to this equation">#</a></span>\[\begin{split}
    \tilde{q}(s) = \left\{
        \begin{array}{ll}
          \tilde{t}(s), &amp; \mbox{$\hat{s} &lt; s$}.\\
          0, &amp; \mbox{$\hat{s} \geq s$}.
        \end{array}
      \right.
      = \left\{
        \begin{array}{ll}
          -2\ln\tilde{\lambda}(s), &amp; \mbox{$\hat{s} &lt; s$}.\\
          0, &amp; \mbox{$\hat{s} \geq s$}.
        \end{array}
      \right.
      = \left\{
      \begin{array}{ll}
          -2\ln\frac{L(s, \hat{\hat{b}}(s))}{L(0, \hat{\hat{b}}(0))}, &amp; \mbox{$\hat{s}&lt;0$}.\\
          -2\ln\frac{L(s, \hat{\hat{b}}(s))}{L(\hat{s}, \hat{b})}, &amp; \mbox{0 $\leq \hat{s} &lt; s$}.\\
          0, &amp; \mbox{$\hat{s} \geq s$}.
        \end{array}
      \right.
\end{split}\]</div>
<p>because we don’t want <span class="math notranslate nohighlight">\(\hat{s} &gt; s\)</span> to indicate lower compatibility for a signal hypothesis of <span class="math notranslate nohighlight">\(s\)</span>. This is what this looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">q_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>

    <span class="n">neg_shat_mask</span> <span class="o">=</span> <span class="n">shat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="c1"># find when s^ is &lt; 0</span>
    <span class="n">t_zero</span> <span class="o">=</span> <span class="n">t_zero_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="c1"># replace values where s^ &lt; 0 with lam_zero</span>
    <span class="n">ts</span><span class="p">[</span><span class="n">neg_shat_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_zero</span><span class="p">[</span><span class="n">neg_shat_mask</span><span class="p">]</span>

    <span class="n">upper_shat_mask</span> <span class="o">=</span> <span class="n">shat</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">s</span>
    <span class="n">ts</span><span class="p">[</span><span class="n">upper_shat_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_ts_qs</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nms</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
    <span class="n">colours</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nms</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">t_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="s2">t</span><span class="se">}}</span><span class="s2">_s$ ($n = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="si">}</span><span class="s2">, m = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">$)&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span>
            <span class="n">q_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="s2">q</span><span class="se">}}</span><span class="s2">_s$ ($n = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="si">}</span><span class="s2">, m = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">$)&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colours</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$s$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nms</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">12.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">)]</span>  <span class="c1"># sample (n, m) observations</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plot_ts_qs</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">nms</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="q-tilde-s">
<img alt="_images/194bd66c3b8a56ab2efe4c2609c2b792b27c9086bc7b636c87306f96ee0ffe81.png" src="_images/194bd66c3b8a56ab2efe4c2609c2b792b27c9086bc7b636c87306f96ee0ffe81.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.2 </span><span class="caption-text">Comparing <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span> and <span class="math notranslate nohighlight">\(\tilde{q}_s\)</span>.</span><a class="headerlink" href="#q-tilde-s" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As you may expect from the plot above, the distribution <span class="math notranslate nohighlight">\(p(\tilde{q}_s|s)\)</span> no longer behaves like a standard <span class="math notranslate nohighlight">\(\chi^2\)</span> but, instead, as a “half-<span class="math notranslate nohighlight">\(\chi^2\)</span>”: essentially a <span class="math notranslate nohighlight">\(\chi^2\)</span> + a delta function at 0 (since, under the signal hypothesis, on average there will be an over-fluctuation half the time, for which <span class="math notranslate nohighlight">\(\tilde{q}_s = 0\)</span>):</p>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_p_ts_qs</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">sbs</span><span class="p">):</span>
    <span class="n">xlim</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">40</span>

    <span class="c1"># getting pdf of half-chi^2 distribution</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">chi2pdf</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">halfchi2pdf</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">chi2pdf</span>
    <span class="n">halfchi2pdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">xlim</span> <span class="o">/</span> <span class="n">bins</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sbs</span><span class="p">):</span>
        <span class="c1"># sample n, m according to our data model (Eq. 1)</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_toys</span><span class="p">),</span> <span class="n">poisson</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_toys</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">t_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$p(\tilde</span><span class="si">{t}</span><span class="s2">_s|s)$&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">q_tilde_s</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$p(\tilde</span><span class="si">{q}</span><span class="s2">_s|s)$&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">halfchi2pdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;half-$\chi^2_{\mathrm</span><span class="si">{DoF}</span><span class="s2">=1}$&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$s = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">, b = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\tilde</span><span class="si">{t}</span><span class="s2">_s$ or $\tilde</span><span class="si">{q}</span><span class="s2">_s$&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sbs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">160</span><span class="p">)]</span>  <span class="c1"># sample s, b</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plot_p_ts_qs</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">sbs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="p-tilde-q">
<img alt="_images/62b8863c289273b29bb8e0e2786173554550347d0390d2d9b80554acd96a2b6d.png" src="_images/62b8863c289273b29bb8e0e2786173554550347d0390d2d9b80554acd96a2b6d.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.3 </span><span class="caption-text">Comparing <span class="math notranslate nohighlight">\(p(\tilde{t}_s|s)\)</span> and <span class="math notranslate nohighlight">\(p(\tilde{q}_s|s)\)</span>.</span><a class="headerlink" href="#p-tilde-q" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p>And this is what our example above looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_p_qs</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the q_tilde_s test statistic distribution via toys.</span>
<span class="sd">    By default, the s we&#39;re testing is the same as the s we&#39;re using for toys,</span>
<span class="sd">    but this can be changed if necessary (as you will see later).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">toy_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toy_s</span> <span class="o">=</span> <span class="n">test_s</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">get_toys</span><span class="p">(</span><span class="n">toy_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q_tilde_s</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_pval_qs</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;p value&quot;&quot;&quot;</span>
    <span class="n">q_tilde_ss</span> <span class="o">=</span> <span class="n">get_p_qs</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="p">)</span>
    <span class="n">q_obs</span> <span class="o">=</span> <span class="n">q_tilde_s</span><span class="p">(</span><span class="n">test_s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">)</span>
    <span class="n">p_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">q_tilde_ss</span> <span class="o">&gt;</span> <span class="n">q_obs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_val</span><span class="p">,</span> <span class="n">q_tilde_ss</span><span class="p">,</span> <span class="n">q_obs</span>


<span class="k">def</span> <span class="nf">get_upper_limit</span><span class="p">(</span><span class="n">s_scan</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span>
    <span class="n">q_tilde_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving sampled test statistics for each s</span>
    <span class="n">q_obs_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving q_obs for each s</span>
    <span class="n">p_val_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving p-value for each s</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_scan</span><span class="p">:</span>
        <span class="n">p_val</span><span class="p">,</span> <span class="n">q_tilde_ss</span><span class="p">,</span> <span class="n">q_obs</span> <span class="o">=</span> <span class="n">get_pval_qs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
        <span class="n">q_obs_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_obs</span><span class="p">)</span>
        <span class="n">q_tilde_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_tilde_ss</span><span class="p">)</span>
        <span class="n">p_val_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_val</span><span class="p">)</span>

    <span class="c1"># find the values of s that give p_value ~= 1 - CL</span>
    <span class="n">pv_cl_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_val_scan</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CL</span><span class="p">))</span>
    <span class="n">s_upper</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">s_upper</span><span class="p">,</span> <span class="n">q_tilde_scan</span><span class="p">,</span> <span class="n">q_obs_scan</span><span class="p">,</span> <span class="n">p_val_scan</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span>
<span class="n">s_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">30.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># scanning s over these values</span>
<span class="n">s_upper_qs</span><span class="p">,</span> <span class="n">q_tilde_scan</span><span class="p">,</span> <span class="n">q_obs_scan</span><span class="p">,</span> <span class="n">p_val_scan</span> <span class="o">=</span> <span class="n">get_upper_limit</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">s_upper_qs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_upper_qs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$s \leq </span><span class="si">{</span><span class="n">s_upper_qs</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[s \leq 24.2\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="c1"># plot p(t_s|s) for all values of s</span>
<span class="n">plot_2d_p_ts_s</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_tilde_s</span><span class="p">,</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span>
<span class="c1"># plot the p-values as a function of t_s and s</span>
<span class="n">plot_pval_levels</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s_scan</span><span class="p">,</span> <span class="n">q_tilde_scan</span><span class="p">,</span> <span class="n">q_obs_scan</span><span class="p">,</span> <span class="n">s_upper_qs</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="s2">&quot;q&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="upperlimits">
<img alt="_images/fce3fc8f593459edb19e724d593724f668153ac6ffe0f4dc8271d3a290e11568.png" src="_images/fce3fc8f593459edb19e724d593724f668153ac6ffe0f4dc8271d3a290e11568.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.4 </span><span class="caption-text">Upper limits using the <span class="math notranslate nohighlight">\(\tilde{q}_s\)</span> test statistic.</span><a class="headerlink" href="#upperlimits" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p><span class="math notranslate nohighlight">\(p(\tilde{q}_s|s)\)</span> is shifted to the left with respect to <span class="math notranslate nohighlight">\(p(\tilde{t}_s|s)\)</span>; hence, the upper limit of <span class="output text_plain">24.2</span> is slightly lower than the upper bound of the 95% confidence interval we derived using <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span>.</p>
</section>
<section id="cl-s-method">
<h3><span class="section-number">3.2.3. </span>CL<span class="math notranslate nohighlight">\(_s\)</span> method<a class="headerlink" href="#cl-s-method" title="Permalink to this heading">#</a></h3>
<p>This is a good point to introduce a few conventions related hypothesis testing and searches in particle physics. First, we usually re-parametrize our parameter of interest <span class="math notranslate nohighlight">\(s\)</span> as:</p>
<div class="math notranslate nohighlight" id="equation-mus">
<span class="eqno">(3.6)<a class="headerlink" href="#equation-mus" title="Permalink to this equation">#</a></span>\[
s \rightarrow \mu \cdot s,
\]</div>
<p>where now <span class="math notranslate nohighlight">\(\mu\)</span> is the parameter of interest, referred to as the “signal strength”, and <span class="math notranslate nohighlight">\(s\)</span> is a fixed value representing the number of signal events we expect to see for a signal strength <span class="math notranslate nohighlight">\(\mu\)</span> of 1. For the example above, if we expect <span class="math notranslate nohighlight">\(s = 10\)</span> signal events, then we could quote the upper limit as <span class="output text_plain">24.2</span><span class="math notranslate nohighlight">\( / s =\)</span> 2.4 on <span class="math notranslate nohighlight">\(\mu\)</span> at 95% CL.</p>
<p>The other convention is that we use a slightly different method for our confidence intervals, called “CL<span class="math notranslate nohighlight">\(_s\)</span>”. This is motivated by cases where we have little sensitivity to the signal we’re searching for.
For example, let’s say we expect <span class="math notranslate nohighlight">\(s = 10\)</span> and observe <span class="math notranslate nohighlight">\(n = 50, m = 100\)</span>. This indicates that our search is not sensitive since our search region is completely dominated by background events and, hence, we should not draw strong conclusions about our signal strength from this test. However let’s see what limit we set for this experiment:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">s_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># scanning s over these values</span>
<span class="n">s_upper</span><span class="p">,</span> <span class="n">q_tilde_scan</span><span class="p">,</span> <span class="n">q_obs_scan</span><span class="p">,</span> <span class="n">p_val_scan</span> <span class="o">=</span> <span class="n">get_upper_limit</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$\mu \leq </span><span class="si">{</span><span class="n">s_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">s</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\mu \leq 0.038\]</div>
</div>
</div>
<p>We end up setting an aggressive limit on <span class="math notranslate nohighlight">\(\mu\)</span> and excluding <span class="math notranslate nohighlight">\(\mu = 1\)</span> (at 95% CL), which is undesirable given our complete lack of sensitivity to the signal.</p>
<p>The idea behind CL<span class="math notranslate nohighlight">\(_s\)</span> is to avoid this by considering both the <span class="math notranslate nohighlight">\(p\)</span>-value of the signal + background hypothesis <span class="math notranslate nohighlight">\(H_s\)</span>, referred to as <span class="math notranslate nohighlight">\(p_{s+b}\)</span> or just <span class="math notranslate nohighlight">\(p_\mu\)</span> for short, <em>and</em> the <span class="math notranslate nohighlight">\(p\)</span>-value of the background-only hypothesis <span class="math notranslate nohighlight">\(H_0\)</span> (<span class="math notranslate nohighlight">\(p_b\)</span>) to define a new criterion:</p>
<div class="math notranslate nohighlight" id="equation-pmu-prime">
<span class="eqno">(3.7)<a class="headerlink" href="#equation-pmu-prime" title="Permalink to this equation">#</a></span>\[
p_\mu' = \cfrac{p_\mu}{1 - p_b}
\]</div>
<p>For cases where the signal region is completely background dominated, the compatibility with the background-only hypothesis should be high so <span class="math notranslate nohighlight">\(p_b \sim 1\)</span> and, hence, <span class="math notranslate nohighlight">\(p_\mu'\)</span> will be increased (as we want). On the other hand, for more sensitive regions, that compatibility should be lower and <span class="math notranslate nohighlight">\(p_b \sim 0\)</span> and <span class="math notranslate nohighlight">\(p_\mu' \sim p_\mu\)</span>.</p>
<p>To be explicit,</p>
<div class="math notranslate nohighlight" id="equation-pb">
<span class="eqno">(3.8)<a class="headerlink" href="#equation-pb" title="Permalink to this equation">#</a></span>\[
p_b = \int^{\tilde{t}_\mathrm{obs}}_{-\infty}p(\tilde{t}_s|0)\mathrm d \tilde{t}_s.
\]</div>
<div class="important admonition">
<p class="admonition-title">Note that:</p>
<ol class="arabic simple">
<li><p>We’re looking at the distribution of <span class="math notranslate nohighlight">\(\tilde{t}_s\)</span>, not <span class="math notranslate nohighlight">\(\tilde{t}_0\)</span>, under the background-only hypothesis; and</p></li>
<li><p>We’re integrating <em>up to</em> <span class="math notranslate nohighlight">\(\tilde{t}_\mathrm{obs}\)</span>, unlike for <span class="math notranslate nohighlight">\(p_s\)</span>, because lower <span class="math notranslate nohighlight">\(\tilde{t}\)</span> means greater compatibility with the background-only hypothesis.</p></li>
</ol>
</div>
<p>Let’s see what this looks like:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_p_ts</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">test_s</span><span class="p">,</span>
    <span class="n">n_obs</span><span class="p">,</span>
    <span class="n">m_obs</span><span class="p">,</span>
    <span class="n">t_tilde_ss</span><span class="p">,</span>
    <span class="n">t_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">toy_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">p_s</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">hlim</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">toy_s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">toy_s</span> <span class="o">=</span> <span class="n">test_s</span>

    <span class="n">test_s_label</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">test_s</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>
    <span class="n">toy_s_label</span> <span class="o">=</span> <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="n">toy_s</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">t_tilde_ss</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">hlim</span><span class="p">,</span> <span class="mi">41</span><span class="p">),</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$p(\tilde</span><span class="se">{{</span><span class="s2">t</span><span class="se">}}</span><span class="s2">_</span><span class="si">{</span><span class="n">test_s_label</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">toy_s_label</span><span class="si">}</span><span class="s2">)$&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ylim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.1</span>

    <span class="k">if</span> <span class="n">t_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span>
            <span class="n">t_obs</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">ylim</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="s2">t</span><span class="se">}}</span><span class="s2">^\mathrm</span><span class="se">{{</span><span class="s2">obs</span><span class="se">}}</span><span class="s2">_</span><span class="si">{</span><span class="n">test_s_label</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">p_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p_s</span><span class="p">:</span>
            <span class="n">p_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$p = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">$&quot;</span> <span class="k">if</span> <span class="n">test_s</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;$p = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">$&quot;</span>
            <span class="k">if</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p_label</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">$Z = </span><span class="si">{</span><span class="n">Z</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span>
                <span class="n">y1</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">where</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">t_obs</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">p_label</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;///&quot;</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$p_b = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">$&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">y1</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">where</span><span class="o">=</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">t_obs</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">p_label</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;lightpink&quot;</span><span class="p">,</span>
                <span class="n">hatch</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;$\tilde</span><span class="se">{{</span><span class="s2">t</span><span class="se">}}</span><span class="s2">_</span><span class="si">{</span><span class="n">test_s_label</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;$s = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">test_s</span><span class="p">)</span><span class="si">}</span><span class="s2">, n_\mathrm</span><span class="se">{{</span><span class="s2">obs</span><span class="se">}}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)</span><span class="si">}</span><span class="s2">, m_\mathrm</span><span class="se">{{</span><span class="s2">obs</span><span class="se">}}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m_obs</span><span class="p">)</span><span class="si">}</span><span class="s2">$&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_pmu_pb</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="n">p_b</span><span class="p">,</span> <span class="n">hlim</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">plot_p_ts</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="n">p_b</span><span class="p">,</span> <span class="n">p_s</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hlim</span><span class="o">=</span><span class="n">hlim</span><span class="p">)</span>
    <span class="n">plot_p_ts</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="n">p_mu</span><span class="p">,</span> <span class="n">hlim</span><span class="o">=</span><span class="n">hlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$p_\mu&#39; = </span><span class="si">{</span><span class="n">p_mu</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p_b</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">lorder</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="n">new_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lorder</span><span class="p">]</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lorder</span><span class="p">]</span>
    <span class="n">new_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$p_\mu = </span><span class="si">{</span><span class="n">p_mu</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">$&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">new_handles</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span>
<span class="n">p_mu</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_obs</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">p_b</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs_b</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span>  <span class="c1"># invert integral for background-only p_value</span>
<span class="n">plot_pmu_pb</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="n">p_b</span><span class="p">,</span> <span class="n">hlim</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">p_mu</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_obs</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">p_b</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs_b</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">p_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span>
<span class="n">plot_pmu_pb</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">t_tilde_ss</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span><span class="p">,</span> <span class="n">p_mu</span><span class="p">,</span> <span class="n">p_b</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<figure class="align-default" id="cls">
<img alt="_images/a1b1974eae1a513c25106e1e46c82d405f1ec33fd268a384dad7fd35a696fd39.png" src="_images/a1b1974eae1a513c25106e1e46c82d405f1ec33fd268a384dad7fd35a696fd39.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.5 </span><span class="caption-text">Demonstration of CL<span class="math notranslate nohighlight">\(_s\)</span> criterion.</span><a class="headerlink" href="#cls" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</div>
</div>
<p>We see that for our first example (left), the background-only distribution is shifted to the right of the <span class="math notranslate nohighlight">\(s+b\)</span> distribution, indicating higher sensitivity, and thus <span class="math notranslate nohighlight">\(p_\mu' \sim p_\mu\)</span>. In the second example, however, the search is not very sensitive and, hence, the background-only and <span class="math notranslate nohighlight">\(s+b\)</span> distributions almost completely overlap <span class="math notranslate nohighlight">\(\Rightarrow p_b \sim 1\)</span> and <span class="math notranslate nohighlight">\(p_\mu' &gt;&gt; p_\mu\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike <span class="math notranslate nohighlight">\(p(\tilde{t}_s|s)\)</span>, <span class="math notranslate nohighlight">\(p(\tilde{t}_s|0)\)</span> <em>doesn’t</em> follow a simple <span class="math notranslate nohighlight">\(\chi^2\)</span>; asymptotically, it is closer to a <em>noncentral <span class="math notranslate nohighlight">\(\chi^2\)</span></em>, as discussed in Ref. <span id="id2">[<a class="reference internal" href="main.html#id4" title="Glen Cowan, Kyle Cranmer, Eilam Gross, and Ofer Vitells. Asymptotic formulae for likelihood-based tests of new physics. Eur. Phys. J. C, 71:1554, 2011. [Erratum: Eur.Phys.J.C 73, 2501 (2013)]. arXiv:1007.1727, doi:10.1140/epjc/s10052-011-1554-0.">1</a>]</span>, and which we’ll get to in Part 5.</p>
</div>
<p>Finally, let’s see if our upper limit make more sense using CL<span class="math notranslate nohighlight">\(_s\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_limits_CLs</span><span class="p">(</span><span class="n">s_scan</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span>
    <span class="n">p_cls_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving p-value for each s</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_scan</span><span class="p">:</span>
        <span class="n">p_mu</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
        <span class="n">p_b</span><span class="p">,</span> <span class="n">t_tilde_sb</span><span class="p">,</span> <span class="n">t_obs</span> <span class="o">=</span> <span class="n">get_ps_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span>
        <span class="n">p_cls_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_mu</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span><span class="p">))</span>

    <span class="c1"># find the values of s that give p_value ~= 1 - CL</span>
    <span class="n">pv_cl_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_cls_scan</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CL</span><span class="p">))</span>
    <span class="n">half_num_s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_scan</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">s_low</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">[:</span><span class="n">half_num_s</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">s_high</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">half_num_s</span><span class="p">:][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">[</span><span class="n">half_num_s</span><span class="p">:])[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">s_low</span><span class="p">,</span> <span class="n">s_high</span>


<span class="k">def</span> <span class="nf">get_upper_limit_CLs</span><span class="p">(</span><span class="n">s_scan</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">CL</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span>
    <span class="n">p_cls_scan</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># saving p-value for each s</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s_scan</span><span class="p">:</span>
        <span class="n">p_mu</span><span class="p">,</span> <span class="n">q_tilde_sb</span><span class="p">,</span> <span class="n">q_obs</span> <span class="o">=</span> <span class="n">get_pval_qs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
        <span class="n">p_b</span><span class="p">,</span> <span class="n">q_tilde_sb</span><span class="p">,</span> <span class="n">q_obs</span> <span class="o">=</span> <span class="n">get_pval_qs</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">,</span> <span class="n">toy_s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p_b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span>
        <span class="n">p_cls_scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_mu</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_b</span><span class="p">))</span>

    <span class="c1"># find the values of s that give p_value ~= 1 - CL</span>
    <span class="n">pv_cl_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_cls_scan</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">CL</span><span class="p">))</span>
    <span class="n">s_upper</span> <span class="o">=</span> <span class="n">s_scan</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pv_cl_diff</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">s_upper</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">s_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># scanning s over these values</span>
<span class="n">s_upper</span> <span class="o">=</span> <span class="n">get_upper_limit_CLs</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$\mu \leq </span><span class="si">{</span><span class="n">s_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">s</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\mu \leq 1.1\]</div>
</div>
</div>
<p>Indeed, we see a looser, more conservative, upper limit. We can also confirm that the limit for our first example, which had better sensitivity, stays the same:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">5</span>
<span class="n">s_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">30.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>  <span class="c1"># scanning s over these values</span>
<span class="n">s_upper</span> <span class="o">=</span> <span class="n">get_upper_limit_CLs</span><span class="p">(</span><span class="n">s_scan</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">,</span> <span class="n">m_obs</span><span class="p">,</span> <span class="n">num_toys</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$\mu \leq </span><span class="si">{</span><span class="n">s_upper</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">s</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\mu \leq 2.4\]</div>
</div>
</div>
</section>
</section>
<section id="summary">
<h2><span class="section-number">3.3. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p>We extended the framework for hypothesis testing to derive frequentist confidence intervals for parameters of interest by solving for particular <span class="math notranslate nohighlight">\(p\)</span>-values, called the “Neyman construction”. For upper limits, we find that we need to use a further modified test statistic <span class="math notranslate nohighlight">\(\tilde{q}_\mu\)</span> and the “CL<span class="math notranslate nohighlight">\(_s\)</span>” method to avoid excluding signals for which we don’t have sensitivity. In Part 4, I’ll discuss the concepts of <em>expected</em> significances and limits, which are important to estimate our experiment’s sensitivity before collecting or looking at the data.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="02-hypothesis-testing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">2. </span>Hypothesis Testing and Upper Limits</p>
      </div>
    </a>
    <a class="right-next"
       href="04-expected-significance-and-limits.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">4. </span>Expected Significances and Limits</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">3.1. Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intervals-and-limits">3.2. Intervals and limits</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confidence-intervals">3.2.1. Confidence intervals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upper-limits">3.2.2. Upper Limits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cl-s-method">3.2.3. CL<span class="math notranslate nohighlight">\(_s\)</span> method</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">3.3. Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Raghav Kansal
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>